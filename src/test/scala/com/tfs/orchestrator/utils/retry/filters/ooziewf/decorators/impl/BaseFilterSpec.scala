package com.tfs.orchestrator.utils.retry.filters.ooziewf.decorators.impl

import com.tfs.orchestrator.utils.{OozieUtils, PropertyReader}
import com.tfs.orchestrator.utils.retry.filters.ooziewf.decorators.{OozieFilter, OozieResponse}
import org.scalatest.FlatSpec

import scala.collection.mutable.ListBuffer
import scala.util.{Failure, Success, Try}

class BaseFilterSpec extends FlatSpec {
  behavior of "BaseFilter"

  it should "return a non empty response" in {
    val oozieFilter: OozieFilter = new BaseFilter() {
      protected override def fetchWFStatus(wfId: String): Option[String] = {
        Option("{\"appName\":\"View_Dimensional_dish_2019-01-07T01:00+0000\",\"externalId\":null,\"conf\":\"<configuration>\\r\\n  <property>\\r\\n    <name>ucInstanceDate<\\/name>\\r\\n    <value>2019-01-07T01:00+0000<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>clientName<\\/name>\\r\\n    <value>dish<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>user.name<\\/name>\\r\\n    <value>oozie<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.coord.application.path<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/coord\\/coord.xml<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobStartTime<\\/name>\\r\\n    <value>2019-01-06T19:00Z<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>mapreduce.job.user.name<\\/name>\\r\\n    <value>oozie<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>viewName<\\/name>\\r\\n    <value>View_Dimensional<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>hdfsConfigDir<\\/name>\\r\\n    <value>\\/etc\\/hadoop\\/conf<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobTracker<\\/name>\\r\\n    <value>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>ingestionType<\\/name>\\r\\n    <value>ALL<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>nameNode<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.libpath<\\/name>\\r\\n    <value>\\/user\\/oozie\\/dp2\\/lib<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>replayTask<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>defaultPublish<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.use.system.libpath<\\/name>\\r\\n    <value>true<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.coord.action.nominal_time<\\/name>\\r\\n    <value>1546822800000<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>waitForInputAvailability<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>userName<\\/name>\\r\\n    <value>SUV<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.wf.rerun.failnodes<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>cronExpression<\\/name>\\r\\n    <value>0 * * * *<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>queueName<\\/name>\\r\\n    <value>LongRun<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.wf.application.path<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/wf\\/workflow.xml<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>skipOutputCheck<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>sleepTime<\\/name>\\r\\n    <value>120<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>hdfsPropertiesDir<\\/name>\\r\\n    <value>\\/user\\/oozie\\/dp2\\/properties\\/<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>workflowForCoord<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/wf\\/workflow.xml<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobComplexity<\\/name>\\r\\n    <value>medium<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobEndTime<\\/name>\\r\\n    <value>2030-10-28T00:00Z<\\/value>\\r\\n  <\\/property>\\r\\n<\\/configuration>\",\"run\":5,\"acl\":null,\"appPath\":\"hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/wf\\/workflow.xml\",\"parentId\":\"0000062-190104041022219-oozie-oozi-C@7\",\"lastModTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"consoleUrl\":\"http:\\/\\/oozie.qa.bigdata.sv2.247-inc.net:11000\\/oozie?job=0000822-190104041009979-oozie-oozi-W\",\"createdTime\":\"Mon, 07 Jan 2019 01:00:01 GMT\",\"startTime\":\"Tue, 08 Jan 2019 09:44:43 GMT\",\"toString\":\"Workflow id[0000822-190104041009979-oozie-oozi-W] status[KILLED]\",\"id\":\"0000822-190104041009979-oozie-oozi-W\",\"endTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"user\":\"oozie\",\"actions\":[{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"-\",\"data\":null,\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"-\",\"errorCode\":null,\"conf\":\"\",\"type\":\":START:\",\"transition\":\"PreprocessTask\",\"retries\":0,\"consoleUrl\":\"-\",\"stats\":null,\"userRetryInterval\":10,\"name\":\":start:\",\"startTime\":\"Tue, 08 Jan 2019 09:44:43 GMT\",\"toString\":\"Action name[:start:] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@:start:\",\"endTime\":\"Tue, 08 Jan 2019 09:44:43 GMT\",\"externalStatus\":\"OK\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"datanode11.h2.dev.bigdata.sv2.247-inc.net:8050\",\"data\":\"#\\n#Tue Jan 08 01:45:39 PST 2019\\nprocess_memory=-Xmx4g\\nEND_EPOCH_TIME=1546819200000\\nnum-executors=3\\nSTART_EPOCH_TIME=1546815600000\\nSTART_TIME=201901062300\\nINPUT_AVAILABLE=false\\nEND_TIME=201901070000\\nQUEUE_NAME=LongRun\\n\",\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"job_1546929339805_0105\",\"errorCode\":null,\"conf\":\"<java xmlns=\\\"uri:oozie:workflow:0.1\\\">\\r\\n  <job-tracker>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/job-tracker>\\r\\n  <name-node>hdfs:\\/\\/nameserviceQAHDP\\/<\\/name-node>\\r\\n  <configuration>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>oozie.launcher.mapreduce.task.classpath.user.precedence<\\/name>\\r\\n      <value>true<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapreduce.job.queuename<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapred.job.queue.name<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n  <\\/configuration>\\r\\n  <main-class>com.tfs.orchestrator.tasks.PreprocessingTask<\\/main-class>\\r\\n  <java-opts>-Dhadoop.config.dir=\\/etc\\/hadoop\\/conf -DisThreadContextMapInheritable=true -Duser.timezone=UTC -Dreplay.task=false -Dproperties.hdfs.dir=\\/user\\/oozie\\/dp2\\/properties\\/<\\/java-opts>\\r\\n  <arg>dish<\\/arg>\\r\\n  <arg>View_Dimensional<\\/arg>\\r\\n  <arg>2019-01-07T01:00+0000<\\/arg>\\r\\n  <arg>medium<\\/arg>\\r\\n  <file>hdfs:\\/\\/nameserviceQAHDP\\/\\/\\/user\\/oozie\\/dp2\\/properties\\/\\/log4j2.properties<\\/file>\\r\\n  <capture-output \\/>\\r\\n<\\/java>\",\"type\":\"java\",\"transition\":\"input_availability\",\"retries\":0,\"consoleUrl\":\"http:\\/\\/datanode11.h2.dev.bigdata.sv2.247-inc.net:8088\\/proxy\\/application_1546929339805_0105\\/\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"PreprocessTask\",\"startTime\":\"Tue, 08 Jan 2019 09:45:14 GMT\",\"toString\":\"Action name[PreprocessTask] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@PreprocessTask\",\"endTime\":\"Tue, 08 Jan 2019 09:45:39 GMT\",\"externalStatus\":\"SUCCEEDED\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"-\",\"data\":null,\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"-\",\"errorCode\":null,\"conf\":\"<switch xmlns=\\\"uri:oozie:workflow:0.1\\\">\\r\\n  <case to=\\\"ProcessingTask\\\">true<\\/case>\\r\\n  <default to=\\\"sleepTask\\\" \\/>\\r\\n<\\/switch>\",\"type\":\"switch\",\"transition\":\"ProcessingTask\",\"retries\":0,\"consoleUrl\":\"-\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"input_availability\",\"startTime\":\"Tue, 08 Jan 2019 09:45:40 GMT\",\"toString\":\"Action name[input_availability] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@input_availability\",\"endTime\":\"Tue, 08 Jan 2019 09:45:40 GMT\",\"externalStatus\":\"ProcessingTask\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"datanode11.h2.dev.bigdata.sv2.247-inc.net:8050\",\"data\":null,\"errorMessage\":\"Main class [org.apache.oozie.action.hadoop.ShellMain], exit code [1]\",\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"job_1546929339805_0106\",\"errorCode\":\"JA018\",\"conf\":\"<shell xmlns=\\\"uri:oozie:shell-action:0.1\\\">\\r\\n  <job-tracker>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/job-tracker>\\r\\n  <name-node>hdfs:\\/\\/nameserviceQAHDP\\/<\\/name-node>\\r\\n  <configuration>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapreduce.job.queuename<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>yarn.nodemanager.pmem-check-enabled<\\/name>\\r\\n      <value>false<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>oozie.launcher.mapreduce.user.classpath.first<\\/name>\\r\\n      <value>true<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapred.job.queue.name<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n  <\\/configuration>\\r\\n  <exec>process_script.sh<\\/exec>\\r\\n  <argument>View_Dimensional<\\/argument>\\r\\n  <argument>dish<\\/argument>\\r\\n  <argument>201901062300<\\/argument>\\r\\n  <argument>201901070000<\\/argument>\\r\\n  <argument>LongRun<\\/argument>\\r\\n  <argument>\\\"\\\"<\\/argument>\\r\\n  <env-var>HADOOP_USER_NAME=oozie<\\/env-var>\\r\\n  <env-var>ID=0000822-190104041009979-oozie-oozi-W<\\/env-var>\\r\\n  <file>hdfs:\\/\\/nameserviceQAHDP\\/\\/\\/user\\/oozie\\/dp2\\/scripts\\/process_script.sh#process_script.sh<\\/file>\\r\\n<\\/shell>\",\"type\":\"shell\",\"transition\":\"SlaPublish2\",\"retries\":0,\"consoleUrl\":\"http:\\/\\/datanode11.h2.dev.bigdata.sv2.247-inc.net:8088\\/proxy\\/application_1546929339805_0106\\/\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"ProcessingTask\",\"startTime\":\"Tue, 08 Jan 2019 09:45:55 GMT\",\"toString\":\"Action name[ProcessingTask] status[ERROR]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@ProcessingTask\",\"endTime\":\"Tue, 08 Jan 2019 09:47:53 GMT\",\"externalStatus\":\"FAILED\\/KILLED\",\"status\":\"ERROR\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"datanode11.h2.dev.bigdata.sv2.247-inc.net:8050\",\"data\":null,\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"job_1546929339805_0108\",\"errorCode\":null,\"conf\":\"<java xmlns=\\\"uri:oozie:workflow:0.1\\\">\\r\\n  <job-tracker>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/job-tracker>\\r\\n  <name-node>hdfs:\\/\\/nameserviceQAHDP\\/<\\/name-node>\\r\\n  <configuration>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapreduce.job.queuename<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapred.job.queue.name<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n  <\\/configuration>\\r\\n  <main-class>com.tfs.orchestrator.tasks.SlaPublishTask<\\/main-class>\\r\\n  <java-opts>-Dhadoop.config.dir=\\/etc\\/hadoop\\/conf -DisThreadContextMapInheritable=true -Duser.timezone=UTC -Dproperties.hdfs.dir=\\/user\\/oozie\\/dp2\\/properties\\/<\\/java-opts>\\r\\n  <arg>dish<\\/arg>\\r\\n  <arg>View_Dimensional<\\/arg>\\r\\n  <arg>2019-01-07T01:00+0000<\\/arg>\\r\\n  <arg>1546815600000<\\/arg>\\r\\n  <arg>1546819200000<\\/arg>\\r\\n  <arg>FAILED<\\/arg>\\r\\n  <file>hdfs:\\/\\/nameserviceQAHDP\\/\\/\\/user\\/oozie\\/dp2\\/properties\\/\\/log4j2.properties<\\/file>\\r\\n  <capture-output \\/>\\r\\n<\\/java>\",\"type\":\"java\",\"transition\":\"fail\",\"retries\":0,\"consoleUrl\":\"http:\\/\\/datanode11.h2.dev.bigdata.sv2.247-inc.net:8088\\/proxy\\/application_1546929339805_0108\\/\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"SlaPublish2\",\"startTime\":\"Tue, 08 Jan 2019 09:47:53 GMT\",\"toString\":\"Action name[SlaPublish2] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@SlaPublish2\",\"endTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"externalStatus\":\"SUCCEEDED\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"-\",\"data\":null,\"errorMessage\":\"Job failed, error message[Main class [org.apache.oozie.action.hadoop.ShellMain], exit code [1]]\",\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"-\",\"errorCode\":\"E0729\",\"conf\":\"Job failed, error message[${wf:errorMessage(wf:lastErrorNode())}]\",\"type\":\":KILL:\",\"transition\":null,\"retries\":0,\"consoleUrl\":\"-\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"fail\",\"startTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"toString\":\"Action name[fail] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@fail\",\"endTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"externalStatus\":\"OK\",\"status\":\"OK\"}],\"status\":\"KILLED\",\"group\":null}")
      }
    }
    val output = oozieFilter.filter("0000822-190104041009979-oozie-oozi-W")
    assert(!output.isEmpty)
  }

  it should "return an empty response when oozie doesnot respond" in {
    val oozieFilter: OozieFilter = new BaseFilter() {
      protected override def fetchWFStatus(wfId: String): Option[String] = {
        None
      }
    }
    val output = oozieFilter.filter("0000822-190104041009979-oozie-oozi-W")
    assert(output.isEmpty)
  }

  it should "return an empty response when oozie respond with different state to SUCCEEDED , KILLED or FAILED" in {
    val oozieFilter: OozieFilter = new BaseFilter() {
      protected override def fetchWFStatus(wfId: String): Option[String] = {
        Option("{\"appName\":\"View_Dimensional_dish_2019-01-07T01:00+0000\",\"externalId\":null,\"conf\":\"<configuration>\\r\\n  <property>\\r\\n    <name>ucInstanceDate<\\/name>\\r\\n    <value>2019-01-07T01:00+0000<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>clientName<\\/name>\\r\\n    <value>dish<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>user.name<\\/name>\\r\\n    <value>oozie<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.coord.application.path<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/coord\\/coord.xml<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobStartTime<\\/name>\\r\\n    <value>2019-01-06T19:00Z<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>mapreduce.job.user.name<\\/name>\\r\\n    <value>oozie<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>viewName<\\/name>\\r\\n    <value>View_Dimensional<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>hdfsConfigDir<\\/name>\\r\\n    <value>\\/etc\\/hadoop\\/conf<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobTracker<\\/name>\\r\\n    <value>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>ingestionType<\\/name>\\r\\n    <value>ALL<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>nameNode<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.libpath<\\/name>\\r\\n    <value>\\/user\\/oozie\\/dp2\\/lib<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>replayTask<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>defaultPublish<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.use.system.libpath<\\/name>\\r\\n    <value>true<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.coord.action.nominal_time<\\/name>\\r\\n    <value>1546822800000<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>waitForInputAvailability<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>userName<\\/name>\\r\\n    <value>SUV<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.wf.rerun.failnodes<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>cronExpression<\\/name>\\r\\n    <value>0 * * * *<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>queueName<\\/name>\\r\\n    <value>LongRun<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>oozie.wf.application.path<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/wf\\/workflow.xml<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>skipOutputCheck<\\/name>\\r\\n    <value>false<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>sleepTime<\\/name>\\r\\n    <value>120<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>hdfsPropertiesDir<\\/name>\\r\\n    <value>\\/user\\/oozie\\/dp2\\/properties\\/<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>workflowForCoord<\\/name>\\r\\n    <value>hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/wf\\/workflow.xml<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobComplexity<\\/name>\\r\\n    <value>medium<\\/value>\\r\\n  <\\/property>\\r\\n  <property>\\r\\n    <name>jobEndTime<\\/name>\\r\\n    <value>2030-10-28T00:00Z<\\/value>\\r\\n  <\\/property>\\r\\n<\\/configuration>\",\"run\":5,\"acl\":null,\"appPath\":\"hdfs:\\/\\/nameserviceQAHDP\\/user\\/oozie\\/dp2\\/wf\\/workflow.xml\",\"parentId\":\"0000062-190104041022219-oozie-oozi-C@7\",\"lastModTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"consoleUrl\":\"http:\\/\\/oozie.qa.bigdata.sv2.247-inc.net:11000\\/oozie?job=0000822-190104041009979-oozie-oozi-W\",\"createdTime\":\"Mon, 07 Jan 2019 01:00:01 GMT\",\"startTime\":\"Tue, 08 Jan 2019 09:44:43 GMT\",\"toString\":\"Workflow id[0000822-190104041009979-oozie-oozi-W] status[KILLED]\",\"id\":\"0000822-190104041009979-oozie-oozi-W\",\"endTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"user\":\"oozie\",\"actions\":[{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"-\",\"data\":null,\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"-\",\"errorCode\":null,\"conf\":\"\",\"type\":\":START:\",\"transition\":\"PreprocessTask\",\"retries\":0,\"consoleUrl\":\"-\",\"stats\":null,\"userRetryInterval\":10,\"name\":\":start:\",\"startTime\":\"Tue, 08 Jan 2019 09:44:43 GMT\",\"toString\":\"Action name[:start:] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@:start:\",\"endTime\":\"Tue, 08 Jan 2019 09:44:43 GMT\",\"externalStatus\":\"OK\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"datanode11.h2.dev.bigdata.sv2.247-inc.net:8050\",\"data\":\"#\\n#Tue Jan 08 01:45:39 PST 2019\\nprocess_memory=-Xmx4g\\nEND_EPOCH_TIME=1546819200000\\nnum-executors=3\\nSTART_EPOCH_TIME=1546815600000\\nSTART_TIME=201901062300\\nINPUT_AVAILABLE=false\\nEND_TIME=201901070000\\nQUEUE_NAME=LongRun\\n\",\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"job_1546929339805_0105\",\"errorCode\":null,\"conf\":\"<java xmlns=\\\"uri:oozie:workflow:0.1\\\">\\r\\n  <job-tracker>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/job-tracker>\\r\\n  <name-node>hdfs:\\/\\/nameserviceQAHDP\\/<\\/name-node>\\r\\n  <configuration>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>oozie.launcher.mapreduce.task.classpath.user.precedence<\\/name>\\r\\n      <value>true<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapreduce.job.queuename<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapred.job.queue.name<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n  <\\/configuration>\\r\\n  <main-class>com.tfs.orchestrator.tasks.PreprocessingTask<\\/main-class>\\r\\n  <java-opts>-Dhadoop.config.dir=\\/etc\\/hadoop\\/conf -DisThreadContextMapInheritable=true -Duser.timezone=UTC -Dreplay.task=false -Dproperties.hdfs.dir=\\/user\\/oozie\\/dp2\\/properties\\/<\\/java-opts>\\r\\n  <arg>dish<\\/arg>\\r\\n  <arg>View_Dimensional<\\/arg>\\r\\n  <arg>2019-01-07T01:00+0000<\\/arg>\\r\\n  <arg>medium<\\/arg>\\r\\n  <file>hdfs:\\/\\/nameserviceQAHDP\\/\\/\\/user\\/oozie\\/dp2\\/properties\\/\\/log4j2.properties<\\/file>\\r\\n  <capture-output \\/>\\r\\n<\\/java>\",\"type\":\"java\",\"transition\":\"input_availability\",\"retries\":0,\"consoleUrl\":\"http:\\/\\/datanode11.h2.dev.bigdata.sv2.247-inc.net:8088\\/proxy\\/application_1546929339805_0105\\/\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"PreprocessTask\",\"startTime\":\"Tue, 08 Jan 2019 09:45:14 GMT\",\"toString\":\"Action name[PreprocessTask] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@PreprocessTask\",\"endTime\":\"Tue, 08 Jan 2019 09:45:39 GMT\",\"externalStatus\":\"SUCCEEDED\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"-\",\"data\":null,\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"-\",\"errorCode\":null,\"conf\":\"<switch xmlns=\\\"uri:oozie:workflow:0.1\\\">\\r\\n  <case to=\\\"ProcessingTask\\\">true<\\/case>\\r\\n  <default to=\\\"sleepTask\\\" \\/>\\r\\n<\\/switch>\",\"type\":\"switch\",\"transition\":\"ProcessingTask\",\"retries\":0,\"consoleUrl\":\"-\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"input_availability\",\"startTime\":\"Tue, 08 Jan 2019 09:45:40 GMT\",\"toString\":\"Action name[input_availability] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@input_availability\",\"endTime\":\"Tue, 08 Jan 2019 09:45:40 GMT\",\"externalStatus\":\"ProcessingTask\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"datanode11.h2.dev.bigdata.sv2.247-inc.net:8050\",\"data\":null,\"errorMessage\":\"Main class [org.apache.oozie.action.hadoop.ShellMain], exit code [1]\",\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"job_1546929339805_0106\",\"errorCode\":\"JA018\",\"conf\":\"<shell xmlns=\\\"uri:oozie:shell-action:0.1\\\">\\r\\n  <job-tracker>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/job-tracker>\\r\\n  <name-node>hdfs:\\/\\/nameserviceQAHDP\\/<\\/name-node>\\r\\n  <configuration>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapreduce.job.queuename<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>yarn.nodemanager.pmem-check-enabled<\\/name>\\r\\n      <value>false<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>oozie.launcher.mapreduce.user.classpath.first<\\/name>\\r\\n      <value>true<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapred.job.queue.name<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n  <\\/configuration>\\r\\n  <exec>process_script.sh<\\/exec>\\r\\n  <argument>View_Dimensional<\\/argument>\\r\\n  <argument>dish<\\/argument>\\r\\n  <argument>201901062300<\\/argument>\\r\\n  <argument>201901070000<\\/argument>\\r\\n  <argument>LongRun<\\/argument>\\r\\n  <argument>\\\"\\\"<\\/argument>\\r\\n  <env-var>HADOOP_USER_NAME=oozie<\\/env-var>\\r\\n  <env-var>ID=0000822-190104041009979-oozie-oozi-W<\\/env-var>\\r\\n  <file>hdfs:\\/\\/nameserviceQAHDP\\/\\/\\/user\\/oozie\\/dp2\\/scripts\\/process_script.sh#process_script.sh<\\/file>\\r\\n<\\/shell>\",\"type\":\"shell\",\"transition\":\"SlaPublish2\",\"retries\":0,\"consoleUrl\":\"http:\\/\\/datanode11.h2.dev.bigdata.sv2.247-inc.net:8088\\/proxy\\/application_1546929339805_0106\\/\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"ProcessingTask\",\"startTime\":\"Tue, 08 Jan 2019 09:45:55 GMT\",\"toString\":\"Action name[ProcessingTask] status[ERROR]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@ProcessingTask\",\"endTime\":\"Tue, 08 Jan 2019 09:47:53 GMT\",\"externalStatus\":\"FAILED\\/KILLED\",\"status\":\"ERROR\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"datanode11.h2.dev.bigdata.sv2.247-inc.net:8050\",\"data\":null,\"errorMessage\":null,\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"job_1546929339805_0108\",\"errorCode\":null,\"conf\":\"<java xmlns=\\\"uri:oozie:workflow:0.1\\\">\\r\\n  <job-tracker>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050<\\/job-tracker>\\r\\n  <name-node>hdfs:\\/\\/nameserviceQAHDP\\/<\\/name-node>\\r\\n  <configuration>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapreduce.job.queuename<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n    <property xmlns=\\\"\\\">\\r\\n      <name>mapred.job.queue.name<\\/name>\\r\\n      <value>LongRun<\\/value>\\r\\n      <source>programatically<\\/source>\\r\\n    <\\/property>\\r\\n  <\\/configuration>\\r\\n  <main-class>com.tfs.orchestrator.tasks.SlaPublishTask<\\/main-class>\\r\\n  <java-opts>-Dhadoop.config.dir=\\/etc\\/hadoop\\/conf -DisThreadContextMapInheritable=true -Duser.timezone=UTC -Dproperties.hdfs.dir=\\/user\\/oozie\\/dp2\\/properties\\/<\\/java-opts>\\r\\n  <arg>dish<\\/arg>\\r\\n  <arg>View_Dimensional<\\/arg>\\r\\n  <arg>2019-01-07T01:00+0000<\\/arg>\\r\\n  <arg>1546815600000<\\/arg>\\r\\n  <arg>1546819200000<\\/arg>\\r\\n  <arg>FAILED<\\/arg>\\r\\n  <file>hdfs:\\/\\/nameserviceQAHDP\\/\\/\\/user\\/oozie\\/dp2\\/properties\\/\\/log4j2.properties<\\/file>\\r\\n  <capture-output \\/>\\r\\n<\\/java>\",\"type\":\"java\",\"transition\":\"fail\",\"retries\":0,\"consoleUrl\":\"http:\\/\\/datanode11.h2.dev.bigdata.sv2.247-inc.net:8088\\/proxy\\/application_1546929339805_0108\\/\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"SlaPublish2\",\"startTime\":\"Tue, 08 Jan 2019 09:47:53 GMT\",\"toString\":\"Action name[SlaPublish2] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@SlaPublish2\",\"endTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"externalStatus\":\"SUCCEEDED\",\"status\":\"OK\"},{\"cred\":null,\"userRetryMax\":0,\"trackerUri\":\"-\",\"data\":null,\"errorMessage\":\"Job failed, error message[Main class [org.apache.oozie.action.hadoop.ShellMain], exit code [1]]\",\"userRetryCount\":0,\"externalChildIDs\":null,\"externalId\":\"-\",\"errorCode\":\"E0729\",\"conf\":\"Job failed, error message[${wf:errorMessage(wf:lastErrorNode())}]\",\"type\":\":KILL:\",\"transition\":null,\"retries\":0,\"consoleUrl\":\"-\",\"stats\":null,\"userRetryInterval\":10,\"name\":\"fail\",\"startTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"toString\":\"Action name[fail] status[OK]\",\"id\":\"0000822-190104041009979-oozie-oozi-W@fail\",\"endTime\":\"Tue, 08 Jan 2019 09:48:17 GMT\",\"externalStatus\":\"OK\",\"status\":\"OK\"}],\"status\":\"RUNNING\",\"group\":null}")
      }
    }
    val output = oozieFilter.filter("0000822-190104041009979-oozie-oozi-W")
    assert(output.isEmpty)
  }

  it should "return entry key" in {
    val filter = new BaseFilter
    val response1 = filter.retrieveEntryKey(OozieResponse("<configuration>\\r\\n  <property>\\r\\n    <name>ucInstanceDate</name>\\r\\n    <value>2019-01-07T01:00+0000</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>clientName</name>\\r\\n    <value>dish</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>user.name</name>\\r\\n    <value>oozie</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.coord.application.path</name>\\r\\n    <value>hdfs://nameserviceQAHDP/user/oozie/dp2/coord/coord.xml</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobStartTime</name>\\r\\n    <value>2019-01-06T19:00Z</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>mapreduce.job.user.name</name>\\r\\n    <value>oozie</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>viewName</name>\\r\\n    <value>View_Dimensional</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>hdfsConfigDir</name>\\r\\n    <value>/etc/hadoop/conf</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobTracker</name>\\r\\n    <value>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>ingestionType</name>\\r\\n    <value>ALL</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>nameNode</name>\\r\\n    <value>hdfs://nameserviceQAHDP/</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.libpath</name>\\r\\n    <value>/user/oozie/dp2/lib</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>replayTask</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>defaultPublish</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.use.system.libpath</name>\\r\\n    <value>true</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.coord.action.nominal_time</name>\\r\\n    <value>1546822800000</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>waitForInputAvailability</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>userName</name>\\r\\n    <value>SUV</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.wf.rerun.failnodes</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>cronExpression</name>\\r\\n    <value>0 * * * *</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>queueName</name>\\r\\n    <value>LongRun</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.wf.application.path</name>\\r\\n    <value>hdfs://nameserviceQAHDP/user/oozie/dp2/wf/workflow.xml</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>skipOutputCheck</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>sleepTime</name>\\r\\n    <value>120</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>hdfsPropertiesDir</name>\\r\\n    <value>/user/oozie/dp2/properties/</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>workflowForCoord</name>\\r\\n    <value>hdfs://nameserviceQAHDP/user/oozie/dp2/wf/workflow.xml</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobComplexity</name>\\r\\n    <value>medium</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobEndTime</name>\\r\\n    <value>2030-10-28T00:00Z</value>\\r\\n  </property>\\r\\n</configuration>", 5, "123", "KILLED", "Wed, 09 Jan 2019 04:39:03 GMT"))
    assert(response1.isDefined)
    val response2 = filter.retrieveEntryKey(OozieResponse("<configuration>\\r\\n  <property>\\r\\n    <name>ucInstanceDate</name>\\r\\n    <value>2019-01-07T01:00+0000</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>clientName</name>\\r\\n    <value>dish</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>user.name</name>\\r\\n    <value>oozie</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.coord.application.path</name>\\r\\n    <value>hdfs://nameserviceQAHDP/user/oozie/dp2/coord/coord.xml</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobStartTime</name>\\r\\n    <value>2019-01-06T19:00Z</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>mapreduce.job.user.name</name>\\r\\n    <value>oozie</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>viewName</name>\\r\\n    <value>View_Dimensional</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>hdfsConfigDir</name>\\r\\n    <value>/etc/hadoop/conf</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobTracker</name>\\r\\n    <value>datanode11.h2.dev.bigdata.sv2.247-inc.net:8050</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>ingestionType</name>\\r\\n    <value>ALL</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>nameNode</name>\\r\\n    <value>hdfs://nameserviceQAHDP/</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.libpath</name>\\r\\n    <value>/user/oozie/dp2/lib</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>replayTask</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>defaultPublish</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.use.system.libpath</name>\\r\\n    <value>true</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.coord.action.nominal_time</name>\\r\\n    <value>1546822800000</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>waitForInputAvailability</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>userName</name>\\r\\n    <value>SUV</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.wf.rerun.failnodes</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>cronExpression</name>\\r\\n    <value>0 * * * *</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>queueName</name>\\r\\n    <value>LongRun</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>oozie.wf.application.path</name>\\r\\n    <value>hdfs://nameserviceQAHDP/user/oozie/dp2/wf/workflow.xml</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>skipOutputCheck</name>\\r\\n    <value>false</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>sleepTime</name>\\r\\n    <value>120</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>hdfsPropertiesDir</name>\\r\\n    <value>/user/oozie/dp2/properties/</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>workflowForCoord</name>\\r\\n    <value>hdfs://nameserviceQAHDP/user/oozie/dp2/wf/workflow.xml</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobComplexity</name>\\r\\n    <value>medium</value>\\r\\n  </property>\\r\\n  <property>\\r\\n    <name>jobEndTime</name>\\r\\n    <value>2030-10-28T00:00Z</value>\\r\\n  </property>\\r\\n</configuration>", 5, "123", "KILLED", "Wed, 09 Jan 2019 04:39:03 GMT"))
    assert(response2.isDefined)
    assert(response1.get == response2.get)


  }

  private def first(x: String): Try[Unit] = {
    Try(second(x))
  }

  private def second(x: String): Unit = {
    if (x.equals("A")) {
      return;
    }
    throw new RuntimeException()
  }
}
